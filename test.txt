function Select-VM([string] $folder){
    $selected_vm=$null
    try{
        $vms = Get-VM -Location $folder
        $index = 1
        foreach($vm in $vms){
            Write-Host "[$index] $($vm.name)"
            $index += 1
        }
        $pick_index = Read-Host "Which index number [x] do you wish to pick?"
        # TODO: Validate index number here
        $selected_vm = $vms[$pick_index - 1]
        Write-Host "You picked $($selected_vm.name)"
        
        # Prompt for snapshot and new VM name
        $snapshotName = Read-Host "Enter the name of the snapshot to use for cloning"
        $newVMName = Read-Host "Enter the name for the new cloned VM"

        # Call Clone-MyVM to clone the selected VM
        Clone-MyVM -originalVM $selected_vm.Name -snapshotName $snapshotName -newVMName $newVMName

    }
    catch {
        Write-Host "An error occurred: $_" -ForegroundColor Red
    }
}

function Clone-MyVM {
    param(
        [string]$originalVM,
        [string]$snapshotName,
        [string]$newVMName
    )

    try {
        Write-Host "Alright, let's get started on cloning! ðŸŽ‰"
        Write-Host "Cloning from: $originalVM using snapshot: $snapshotName"
        Write-Host "New VM will be named: $newVMName"

        $sourceVM = Get-VM -Name $originalVM
        $snap = Get-Snapshot -VM $sourceVM -Name $snapshotName
        $hostMachine = Get-VMHost -Name "192.168.7.20"
        $datastore = Get-Datastore -Name "datastore1"

        $cloneName = "{0}.linked" -f $sourceVM.Name
        $linkedVM = New-VM -LinkedClone -Name $cloneName -VM $sourceVM -ReferenceSnapshot $snap -VMHost $hostMachine -Datastore $datastore
        $brandNewVM = New-VM -Name $newVMName -VM $linkedVM -VMHost $hostMachine -Datastore $datastore
        $brandNewVM | New-Snapshot -Name "Initial Setup"

        # Optionally, clean up by removing the linked clone VM
        $linkedVM | Remove-VM -Confirm:$false

        Write-Host "Your new VM, $newVMName, is ready to go! ðŸš€"
    }
    catch {
        Write-Host "Uh oh, ran into a snag! ðŸš¨" -ForegroundColor Red
        exit
    }
}

# Now you can run Select-VM and provide a folder to pick and clone a VM
